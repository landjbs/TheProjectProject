{% from 'macros/cards/badge.html' import render_badge_icon %}
{% from 'macros/cards/components.html' import render_share_button %}


<!-- collaboration -->
{% macro render_collaborate_button(user) -%}
  {% if g.current_user!=user %}
    <button type="button" class="btn" data-toggle="modal" data-target="#modal_user_{{ user.id }}">
        Collab
    </button>
  {% else %}
    <button type="button" class="btn" disabled>
        You!
    </button>
  {% endif %}
{% endmacro -%}


<!-- action bar -->
{% macro render_user_action_bar(user) -%}
<div class='action-bar'>
  <center>
    {% if g.current_user!=user %}
      <div class='hoverable'>
        <i class="fa fa-ellipsis-v" aria-hidden="true"></i>
        <span class='tooltiptext'>
          <a data-toggle='modal' data-target='#report_modal_{{ user.id }}'>
            Report User
          </a>
        </span>
      </div>
    {% else %}
      <form action="{{ url_for('user.flash_encouragement') }}" style='display:inline;' method='post'>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button style='background:transparent; color: #F82B91; border:0;'>
          <i class="fa fa-heart" aria-hidden="true"></i>
        </button>
      </form>
    {% endif %}
    &nbsp;
    {{ render_collaborate_button(user) }}
    &nbsp;
    {{ render_share_button(user, 'user') }}
  </center>
</div>
{% endmacro -%}


<!-- user card -->
{% macro render_user_card(user, carousel_type='search') -%}
<div class="col-md-4">
  <div class="card mb-2">
    <div class="card-body">
      <div class='card-head tiny'>
        <a class='project-name' href='user={{ user.code }}'>
          <h5>
            {{ user.name }}
            {% set badge = user.choose_badge(carousel_type) %}
            {% if badge %}
              {{ render_badge_icon(badge) }}
            {% endif %}
            {% if user.recently_active() %}
              <i class="fa fa-circle fa-sm" style='color:#00FF5D;'></i>
            {% endif %}
          </h5>
        </a>
      </div>
      <div class='card-oneline' style=''>
        <p class='oneliner'>
          {{ user.about }}
        </p>
      </div>
      <div class='card-foot float-left'>
        {% for s in user.subjects[:5] %}
          <a href='/subject={{ s.subject.code }}'>
            {% if loop.index>1 %}
            ,
            {% endif %}
            <p class='subject-tag' style='background:{{ s.subject.color }};'>
              {{ s.subject.name }}
            </p>
          </a>
        {% endfor %}
      </div>
      <br>
      <hr class="my-2">
      {{ render_user_action_bar(user) }}
    </div>
  </div>
</div>
{% endmacro -%}


<!-- MODALS -->
{% macro render_collaborate_modal(user, target_project=None) -%}
{% set modal_id = "modal_project_{user_id}".format(user_id=user.id) %}
<div id="{{ modal_id }}" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <!-- Modal content-->
    <div class="modal-content">
      <div class="modal-header">
        <a href='user={{ user.code }}' style='color:black;'>
          <h5>{{ user.name }}</h5>
        </a>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>
      {% if (g.current_user.owned.count())>0 %}
      <form action="{{ url_for('user.collaborate', user_id=user.id) }}" method='post'>
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <div class="modal-body">
          <label for="new_owner">Select project on which to collaborate with {{ user.name }}:</label>
          <br>
          <select name="selected_project" id="selected_project" class='select-clean'>
            {% for project in g.current_user.owned %}
              {% if (project.complete!=True) and (project.open==True) and (user not in project.members) and (user not in project.invitations )%}
                {% if project==target_project %}
                  <option value="{{ project.id }}" selected>{{ project.name }}</option>
                {% else %}
                  <option value="{{ project.id }}">{{ project.name }}</option>
                {% endif %}
              {% endif %}
            {% endfor %}
          </select>
          <br><br>
          <p>{{ user.name }} will be sent an invitation
            and will be able to join without applying.
          </p>
        </div>
        <div class="modal-footer">
          <button class='btn'>Collaborate</button>
        </div>
      </form>
      {% else %}
        <div class="modal-body">
          <p>Cannot invite {{ user.name }} to collaborate because
            you do not own any projects! Try <a href='/add_project'>adding a project</a> first.
          </p>
        </div>
        <div class="modal-footer">
          <a href='/add_project'>
            <button class='btn'>Add Project</button>
          </a>
        </div>
      {% endif %}
    </div>
  </div>
</div>
<script>
  $('#{{ modal_id }}').appendTo('body');
</script>
{% endmacro -%}
