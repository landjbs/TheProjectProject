{% extends "home_base.html" %}
{% import 'macros.html' as macros %}

{% block title %}{{ user.name }}{% endblock %}

{% block head %}
  {{ super() }}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <!-- Our Custom CSS -->
    <link rel="stylesheet" href="css/scroll_styles.css">
    <link rel="stylesheet" href="css/project_styles.css">
    <link rel='stylesheet' href="css/badge_styles.css">
    <link rel='stylesheet' href="css/mobile_profile_styles.css">
{% endblock %}

{% block content %}
    <!-- PAGE -->
    <div class='container' style="min-width:100%;padding:0px;">
        <nav class='sidebar-header sticky-top' id='nameNav'>
        <div class='nav-keep' style='padding-bottom:2vh; padding-top:2vh;'>
          <p class='float-right'>
            <i class="fa fa-star"></i>
            {{ user.total_stars() }}
            <!-- edit button -->
            {% if user == current_user %}
                <br>
                <button type='button' data-toggle='modal' data-target='#edit_modal' class='edit-button'>
                  <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                  Edit
                </button>
            {% endif %}
          </p>
          <a href='/user={{ user.code }}'>
            <h3>
              {{ user.name }}
              {% set badge = user.choose_badge('search') %}
              {% if badge %}
                {{ macros.render_badge_icon_bigger(badge) }}
              {% elif user.recently_active() %}
                <i class="fa fa-circle fa-sm" style='color:#00FF5D;'></i>
              {% endif %}
            </h3>
          </a>
          {% if current_user.is_authenticated %}
            <a href='mailto:{{ user.email }}'>
              {{ user.email }}
            </a>
          {% endif %}
        </div>
        <div id='nav-expanded'>
          <hr class='my-2' style='background:white;'>
          <p>{{ user.about }}</p>
          <center>
            {% if current_user.is_authenticated %}
                {{ macros.render_user_action_bar(current_user, user) }}
            {% endif %}
          </center>
          <br>
        </div>
      </nav>

      <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'Owned')" id="defaultOpen">Owned</button>
        <button class="tablinks" onclick="openTab(event, 'Member')">Member</button>
        {% if current_user==user %}
          <button class="tablinks" onclick="openTab(event, 'Invitations')">Invitations</button>
          <button class="tablinks" onclick="openTab(event, 'Applications')">Applications</button>
        {% endif %}
        <button class="tablinks" onclick="openTab(event, 'Subjects')">Subjects</button>
        <button class="tablinks" onclick="openTab(event, 'Tasks')">Tasks</button>
      </div>

      <div id="Owned" class="tabcontent">
        <h4 class='tabname-big'>
          Owned Projects
          <i class="fa fa-circle" style='color:#FF5D00;'></i>
          {{ user.owned.count() }}
        </h4>
        {% if user.owned.count() > 0 %}
          {% for project in user.owned %}
            {{ macros.render_big_project_card(current_user, project, now, calc_days_since) }}
          {% endfor %}
        {% endif %}
      </div>

      <div id="Member" class="tabcontent">
        <h4 class='tabname-big'>
          Member Projects
          <i class="fa fa-circle-o" style='color:#FF5D00;'></i>
          {{ (user.projects.count()) - (user.owned.count()) }}
        </h4>
        {% if ((user.projects.count()) - (user.owned.count())) > 0 %}
          {% for project in user.projects %}
            {% if user!=project.owner %}
              {{ macros.render_big_project_card(current_user, project, now, calc_days_since) }}
            {% endif %}
          {% endfor %}
        {% endif %}
      </div>

      <div id="Subjects" class="tabcontent">
        <h4 class='tabname-big'>
          Subjects
          <i class="fa fa-flask" style='color:#FF5D00;'></i>
          {{ user.total_skill_level() }}
        </h4>
        {% for user_subject in user.subjects %}
          {{ macros.render_user_subject(user_subject) }}
        {% endfor %}
      </div>

      <div id="Invitations" class="tabcontent">
        <h4 class='tabname-big'>
          Invitations
          <i class="fa fa-bell" aria-hidden="true" style='color:#FF5D00;'></i>
          {{ user.invitations.all()|length }}
        </h4>
        {% for invitation in user.invitations %}
          <div class="list-group-item list-group-item-action flex-column align-items-start pending-item">
            <a href='project={{ invitation.code }}' class="mb-1 user-name"
            style='background: transparent; color: white; padding:0px;'>
              {{ invitation.name }}
            </a>
            <p class="mb-1">
                {{ invitation.oneliner }}
              <div class='hoverable'>
                <a class='delete-btn task-btn float-left'
                style='background: transparent;'
                href="{{ url_for('user.reject_collaboration', project_id=invitation.id) }}">
                  <i class="fa fa-times-circle" aria-hidden="true"></i>
                </a>
              <span class='tooltiptext'>Decline</span>
              </div>
              <div class='hoverable'>
                <a class='complete-btn task-btn float-right'
                style='background: transparent;'
                href="{{ url_for('user.accept_collaboration', project_id=invitation.id) }}">
                  <i class="fa fa-check-circle" aria-hidden="true"></i>
                </a>
                <span class='tooltiptext'>Accept</span>
              </div>
            </p>
          </div>
        {% endfor %}
      </div>

      <div id="Applications" class="tabcontent">
        <h4 class='tabname-big'>
          Applications
          <i class="fa fa-paper-plane" aria-hidden="true" style='color:#FF5D00;'></i>
          {{ user.pending.all()|length }}
        </h4>
        {% for application in user.pending %}
          <div class="list-group-item list-group-item-action flex-column align-items-start pending-item">
            <a href='project={{ application.project.code }}' class="mb-1 user-name"
            style='background: transparent; color: white; padding:0px;'>
              {{ application.project.name }}
            </a>
            <p class="mb-1" style='color:white;'>
                {{ application.project.oneliner }}
              <div class='hoverable'>
                <a class='task-btn float-right'
                style='background: transparent; color:white;'
                href="{{ url_for('project.withdraw_application', project_id=application.project.id) }}">
                  <i class="fa fa-times-circle" aria-hidden="true"></i>
                </a>
                <span class='tooltiptext'>Withdraw Application</span>
              </div>
            </p>
          </div>
        {% endfor %}
      </div>

      <div id="Tasks" class="tabcontent">
        {% set completed_tasks = user.tasks_worked %}
        <h4 class='tabname-big'>
          Completed Tasks
          <i class="fa fa-check-circle" style='color:#FF5D00;'></i>
          {{ completed_tasks|length }}
        </h4>
        {% for task in completed_tasks|reverse %}
          <div class="list-group-item list-group-item-action flex-column align-items-start">
            <h6 class="mb-1">{{ task.text }}</h6>
            <div class="d-flex w-100 justify-content-between">
              <small>Completed
              on {{ time_to_str(task.complete_stamp) }}
            for
            {% if current_user.is_authenticated %}
              <a href='project={{ task.project.code }}' class='user-name'>
            {% else %}
              <a href='/login' class='user-name'>
            {% endif %}
              {{ task.project.name }}
            </a></small>
            </div>
          </div>
        {% endfor %}
      </div>

    </div>

    <!-- modals -->
    <div>
      {% if current_user.is_authenticated %}
        <!-- user modal -->
        {% if current_user!=user %}
          <!-- collaborate -->
          {{ macros.render_collaborate_modal(current_user, user) }}
          {{ macros.render_report_modal(user) }}
        {% else %}
          <!-- edit and delete modals -->
          {{ macros.render_edit_user_modal(user, edit_form) }}
          {{ macros.render_delete_account_modal(user) }}
        {% endif %}
        <!-- project modals -->
        {% for project in user.projects %}
            {{ macros.render_join_modal(current_user, project, project_application) }}
        {% endfor %}
      {% endif %}
    </div>
    <!-- /modals -->

    <!-- jQuery CDN - Slim version (=without AJAX) -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <!-- Popper.JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>

    <script>
      document.getElementById("defaultOpen").click();
      function openTab(evt, cityName) {
        var i, tabcontent, tablinks;
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        document.getElementById(cityName).style.display = "block";
        evt.currentTarget.className += " active";
      }
    </script>

    <!-- shrink navbar about and progress section -->
    <script>
    window.onscroll = function() {scrollFunction()};

    function scrollFunction() {
      if (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) {
        var disp = $('#nav-expanded').css('display');
        if (disp=='block') {
          var h = $('#nav-expanded').height();
          document.getElementById("nav-expanded").style.display = 'none';
          window.scrollBy(0, h+10);
        } else {
            document.getElementById("nav-expanded").style.display = 'none';
        }
      // show
      } else if (document.body.scrollTop == 0) {
        var disp = $('#nav-expanded').css('display');
        if (disp=='none') {
          document.getElementById("nav-expanded").style.display = 'block';
          var h = $('#nav-expanded').height();
          window.scrollBy(0, -h-10);
        } else {
          document.getElementById("nav-expanded").style.display = 'block';
        }
      }
    }
    </script>

  {% endblock %}


  else {
    document.getElementById("nav-expanded").style.display = "block";
  }
