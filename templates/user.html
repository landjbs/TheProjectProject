{% extends "home_base.html" %}

{% block title %}{{ user.name }}{% endblock %}

{% block head %}
  {{ super() }}
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <!-- Our Custom CSS -->
    <link rel="stylesheet" href="css/scroll_styles.css">
    <link rel="stylesheet" href="css/project_styles.css">
{% endblock %}

{% block content %}
    <!-- PAGE -->
    <div class="wrapper">
        <!-- Sidebar Holder -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <p class='float-right'>
                  <i class="fa fa-star"></i>
                  <br>
                  <i class="fa fa-circle" style='color:#FF5D00;'></i>
                  {{ user.owned|length }}
                  <br>
                  <i class="fa fa-circle-thin" style='color:#FF5D00;'></i>
                  {{ (user.projects.all()|length) - (user.owned|length) }}
                  <!-- edit button -->
                  {% if user == current_user %}
                    <br>
                    <a href='/'>
                      <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                      Edit
                    </a>
                  {% endif %}
                </p>
                <a href='/user={{ user.email }}'>
                  <h3>{{ user.name }}</h3>
                </a>
                <a href='mailto:{{ user.email }}'>
                  {{ user.email }}
                </a>
            </div>
            <br>
            <ul class="list-unstyled components">
              <!-- <div class='bio'> -->
                <p class='oneliner'>
                  {{ user.about }}
                </p>
              <!-- </div> -->
            </ul>
        </nav>

        <!-- Page Content Holder -->
        <div id="content">
            <div class="row">
              <div class="col-sm-4">
                <h6>Daily Activity</h6>
                {% if task_data %}
                  <canvas id="activity_chart"></canvas>
                {% else %}
                  <p class='empty-text'>No activity yet.</p>
                {% endif %}
              </div>

              <div class="col-sm-4">
                <h6>Completed Tasks</h6>
                  {% set completed_tasks = user.tasks_worked %}
                  <div class="list-group list-small">
                    {% if completed_tasks|length==0 %}
                      <p class='empty-text'>No tasks completed yet.</p>
                    {% endif %}
                    {% for task in completed_tasks|reverse %}
                      <div class="list-group-item list-group-item-action flex-column align-items-start">
                        <h6 class="mb-1">{{ task.text }}</h6>
                        <div class="d-flex w-100 justify-content-between">
                          <small>Completed by
                            {% for worker in task.workers %}
                                {% if loop.index==(task.workers|length) %}
                                  <a href='user={{ worker.email }}' class='user-name'>
                                    {{ worker.name }}
                                  </a>
                                {% elif (task.workers|length)==2 %}
                                  <a href='user={{ worker.email }}' class='user-name'>
                                    {{ worker.name }}
                                  </a>
                                  and
                                {% else %}
                                  <a href='user={{ worker.email }}' class='user-name'>
                                    {{ worker.name }}
                                  </a>
                                {% endif %}
                            {% endfor %}
                          on {{ time_to_str(task.complete_stamp) }}</small>
                        </div>
                      </div>
                    {% endfor %}
                  </div>
              </div>

              <div class="col-sm-4">
                <h6>Role Breakdown</h6>
                {% if role_data %}
                  <canvas id="role_breakdown"></canvas>
                {% else %}
                  <p class='empty-text'>No roles yet.</p>
                {% endif %}
              </div>
            </div>

            <div class="line"></div>

            <h5>Owned Projects</h5>
            <div id="rec-carousel" class="carousel slide carousel-multi-item" data-ride="carousel">
              <!--Slides-->
              <div class="carousel-inner" role="listbox">
                {% for tab in recommended_tabs %}
                  {% if loop.index==1 %}
                  <div class="carousel-item active">
                  {% else %}
                  <div class="carousel-item">
                  {% endif %}
                    <div class='row'>
                      {% for project in tab %}
                        <div class="col-md-4">
                          <div class="card mb-2">
                            <div class="card-body">
                              <div class='member-hoverable float-right'>
                                <span class="tooltiptext">
                                  {% for member in project.members %}
                                    <p>{{ member.user.name }}</p>
                                  {% endfor %}
                                </span>
                                <i class='far fa-user-circle'></i>
                                {{ project.members.all()|length }}
                                <br>
                                <i class="fa fa-star"></i>
                                {{ project.stars.all()|length }}
                              </div>
                              <div class='card-head'>
                                <a class='project-name' href='project={{ project.name }}'>
                                  <h5>{{ project.name }}</h5>
                                </a>
                                <a href='user={{ project.owner.email }}'>
                                  <p class='owner'>{{ project.owner.name }}</p>
                                </a>
                              </div>
                              <hr class="my-4">
                              <!-- summary -->
                              <div class='card-text'>
                                <p class='oneliner'>
                                  {{ project.oneliner }}
                                </p>
                                <p style='color:rgba(0,0,0,0.7);'>{{ project.summary }}</p>
                              </div>
                              <div class='card-foot float-left'>
                                <p style="padding-bottom:0px; margin-bottom:0px;">
                                  <i class="fa fa-clock-o"></i>
                                  {{ project.estimated_time }} days left
                                </p>
                                <div>
                                  <i class="fa fa-flask" aria-hidden="true"></i>
                                  {% for subject in project.subjects|reverse %}
                                    <a href='/subject={{ subject.name }}'>
                                      {% if loop.index>1 %}
                                      ,
                                      {% endif %}
                                      <p class='subject-tag' style='background:{{ subject.color }};'>
                                        {{ subject.name }}
                                      </p>
                                    </a>
                                  {% endfor %}
                                </div>
                              </div>
                              <br><br>
                              <hr class="my-4">
                              <div class='action-bar'>
                                {% if current_user.has_starred(project) %}
                                  <a href="{{ url_for('like_action', project_id=project.id, action='unlike') }}">
                                    <i class="fa fa-star"></i>
                                  </a>
                                {% else %}
                                  <a href="{{ url_for('like_action', project_id=project.id, action='like') }}">
                                    <i class="fa fa-star-o"></i>
                                  </a>
                                {% endif %}
                                &nbsp;
                                {% if not is_project_member(current_user, project) %}
                                  <button type="button" class="btn" data-toggle="modal" data-target="#modal_{{ project.id }}">
                                      Join
                                  </button>
                                {% elif current_user in project.pending %}
                                    Pending
                                {% else %}
                                  <button type="button" class="btn" data-toggle="modal" data-target="#modal_{{ project.id }}">
                                      Leave
                                  </button>
                                {% endif %}
                                &nbsp;
                                <i class="fa fa-share-alt" aria-hidden="false"></i>
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% endfor %}
              </div>
              <!--Controls-->
              <div class="controls-top">
                <a class="btn-floating" href="#rec-carousel" data-slide="prev"><i class="fa fa-chevron-circle-left fa-lg"></i></a>
                <a class="btn-floating" href="#rec-carousel" data-slide="next"><i class="fa fa-chevron-circle-right fa-lg"></i></a>
              </div>
              <!--/.Controls-->
            </div>
          </div>


            <h5>Member Projects</h5>

        </div>

    </div>

    <!-- jQuery CDN - Slim version (=without AJAX) -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <!-- Popper.JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <!-- Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.js"></script>

    <script>
    Chart.defaults.global.legend.display = false;

    // daily activity
    {% if task_data %}
      var ctx = document.getElementById('activity_chart');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: [{% for i in range(task_data['earliest']) %}
                    '{{ i }}',
                  {% endfor %}],
          datasets: [
            {
              data: [{% for activity in task_data['end_activity'] %}
                        '{{ activity }}',
                      {% endfor %}],
              label: "Task Completed",
              borderColor: "#FF5D00",
              backgroundColor: "rgba(255,93,0,0.5)",
              fill: false
            }
          ]
        },
        options: {
            scales: {
                yAxes: [{
                    ticks: {
                        beginAtZero: true
                    }
                }]
            }
        }
      });
    {% endif %}

    {% if role_data %}
      var ctx = document.getElementById('role_breakdown');
      var myRadarChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: [{% for k in role_data.keys() %}
                      '{{ k.name }}',
                    {% endfor %}],
            datasets: [{
              data: [{% for v in role_data.values() %}
                        '{{ v }}',
                      {% endfor %}],
              fill: true,
              backgroundColor: ['rgba(93, 0, 255,0.5)'],
              borderColor: ['#5D00FF'],
              pointBorderColor: ['#5D00FF'],
              pointBackgroundColor: ['#5D00FF'],
              pointHoverBackgroundColor: ['#5D00FF'],
              pointHoverBorderColor: ['#5D00FF']
            }
          ]
        },
        options: {
          scale: {
                angleLines: {
                display: false
            },
            ticks: {
                suggestedMin: 0,
                display: false
            },
          }
        }
      });
    {% endif %}


  </script>


  {% endblock %}
